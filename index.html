<!-- Copyright (c) 2014, Guilherme Ramos <longinus@gmail.com> -->
<!-- Released under the MIT license. See LICENSE file for details. -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
    <title>Home Control</title>

    <!-- Bootstrap and Bootstrap-Slider CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/jquery.nouislider.min.css" rel="stylesheet">
    <style>
        .container {
            background: #fff;
        }
        #sl1 {
            width: 400px;
        }
        .label {
          padding: .2em .2em .3em;
        }
        .row {margin:  -7.5px}
        [class*="col-"] {padding: 0 5px;}

    </style>

    <!-- jQuery -->
    <script type="text/javascript" src="js/jquery.min.js"></script>
    <!-- socket.io for communication -->
    <script type="text/javascript" src="js/socket.io.min.js"></script>
    <script type="text/javascript">
        //Connect to socket and MQTT broker
        var socket = io.connect('http://192.168.0.175:3000');

        //Global variables
        var MPCBar_total = 0;
        var debug_show = false;  //If it's on, no panels will be hidden

        socket.on('connect', function () {
            socket.on('mqtt', function (msg) {

                //Process specific topics received
                switch (msg.topic) {

                case 'home/light/1/status':
                    if (msg.payload == 'on') {
                        $('#Light_1').html('<span class="glyphicon glyphicon-ok"></span> ON');                        
                        $('#Light_1').removeClass('btn-danger').addClass('btn-success');
                    } else {
                        $('#Light_1').html('<span class="glyphicon glyphicon-remove"></span> OFF');   
                        $('#Light_1').removeClass('btn-success').addClass('btn-danger');
                    }
                    break;

                case 'home/light/1/status/brightness':
                    $('#Light_1_Brightness').text(msg.payload);
                    $('#slider1').val(parseInt(msg.payload));
                    break;

                case 'home/player/mpc':
                    if (msg.payload == 'on' || debug_show) {
                        $('#Player_MPC').removeClass('hide');
                    } else {
                        $('#Player_MPC').addClass('hide');
                    }
                    break;

                case 'home/player/mpc/status/total_time':
                    MPCBar_total = msg.payload;
                    break;

                case 'home/player/mpc/status/current_time':
                    var current_time = parseInt(msg.payload);
                    document.getElementById('MPCBar').style.width = ((current_time * 100) / MPCBar_total) + '%';
                    break;

                case 'home/player/mpc/status/playing':
                    if (msg.payload == '1') {
                        $('#MPCBar').removeClass('hide');
                    } else {
                        $('#MPCBar').addClass('hide');
                    }
                    break;
                
                case 'home/player/mpc/status/filename':
                    if (msg.payload != "" && msg.payload != "0") {
                        $('#mpc_filename').html(msg.payload); 
                    } else {
                        $('#mpc_filename').html(''); 
                    }

                    break;
                }

                //Status messages                   
                $('#message').html(msg.topic + ', ' + msg.payload);

            });

            //Topic subscriptions
            socket.emit('subscribe', 
                {topic: 'home/light/1/status/#'}, 
                {topic: 'home/player/mpc'}, 
                {topic: 'home/player/mpc/status/#'}
                );

        });
    </script>
</head>

<body>
    <div id="wrap">
        <div class="container">
            <div class="page-header">
                <h3><b>Home Control</b></h3>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title"><span class="label label-default"><span class="glyphicon glyphicon-flash"></span> Light Control</span></h3>
                </div>
                <div class="panel-body">
                    <div class="row">
                        <div class="col-xs-4" >
                            <h2><span class="label label-info" style="vertical-align:top; display: block; text-align:left; padding: .2em .4em .3em;">Light Corner</span></h2>
                        </div>
                        <div class="col-xs-1">
                            <h2><span id="Light_1_Brightness" class="label label-default" style="vertical-align:top; display: block;">N/A</span></h2>
                        </div>
                        <div class="col-xs-5" style="text-align:center; padding-top: 28px; padding-left: 20px; padding-right: 20px">                            
                            <div class="noUiSlider" id="slider1"></div>                            
                        </div>
                        <div class="col-xs-2" style="text-align:right; vertical-align:center; padding-top: 14px; "><a href="#" id="Light_1" class="btn btn-block btn-lg btn-success" role="button" style="vertical-align:bottom; "><span class="glyphicon glyphicon-ok"></span> N/A</a>
                        </div>
                    </div>                    
                </div>
            </div>

            <div class="panel panel-default" id="Player_MPC">
                <div class="panel-heading">
                    <h3 class="panel-title"><span class="label label-default"><span class="glyphicon glyphicon-film"></span> Media Player Control</span></h3>
                </div>
                <div class="panel-body">

                    <small id="mpc_filename">Filename of file playing</small>

                    <div class="progress progress-striped active">
                        <div class="progress-bar" id="MPCBar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
                    </div>

                    <div class="row">
                        <div class="col-xs-2">
                            <button type="button" id="MPC_PlayPause" class="btn btn-primary btn-lg btn-block">
                            <span class="glyphicon glyphicon-play"></span> Play
                            </button>
                        </div>
                        <div class="col-xs-2">
                            <button type="button" id="MPC_PlayPause" class="btn btn-primary btn-lg btn-block">
                            <span class="glyphicon glyphicon-pause"></span> Pause
                            </button>
                        </div>
                        <div class="col-xs-2">
                            <button type="button" id="MPC_Stop" class="btn btn-primary btn-lg btn-block">
                            <span class="glyphicon glyphicon-stop"></span> Stop
                            </button>
                        </div>
                        <div class="col-xs-2">
                            <button type="button" id="MPC_VolUp" class="btn btn-primary btn-lg btn-block">
                            <span class="glyphicon glyphicon-volume-up"></span> Vol. Up
                            </button>
                        </div>
                        <div class="col-xs-2">
                            <button type="button" id="MPC_VolDown" class="btn btn-primary btn-lg btn-block">
                            <span class="glyphicon glyphicon-volume-down"></span> Vol. Down
                            </button>
                        </div>
                        <div class="col-xs-2">
                            <button type="button" id="MPC_Fullscreen" class="btn btn-primary btn-lg btn-block">
                            <span class="glyphicon glyphicon-fullscreen"></span> Fullscreen
                            </button>
                        </div>
                    </div>

                </div>
            </div>

            <div class="panel panel-default">
                <div class="panel-body">
                    <b>Latest MQTT message:  </b>  <small id="message">no message recieved</small>
                </div>
            </div>

            <div class="footer">
                <small><p class="text-center">Longinus 2014</p></small>
            </div>

            <!-- .noUIslider Slider -->
            <script src="js/jquery.nouislider.min.js"></script>
            <script src="js/modernizr.js"></script>                

            <script>

                // Run noUiSlider
                $('.noUiSlider').noUiSlider({
                    range: [0, 100]
                    ,start: 0
                    ,step: 1
                    ,handles: 1     
                    ,serialization: {
                        resolution: 1
                    }
                    ,set: function(){                        
                        socket.emit('publish', {
                            topic: 'home/light/1/set',
                            message: new String($("#slider1").val())
                        });
                    }           
                });


                //Button event handler. Redirects to the appropriate function 
                $('.btn').click(function () {
                    //Get type of button from the start of the ID
                    var id_type = this.id.split("_");

                    switch (id_type[0]) {

                    case 'MPC':
                        MPCControl($(this));
                        break;

                    case 'Light':
                        LightControl($(this));
                        break;
                    }
                });

                 //Send light messages on button press
                function LightControl(controller) {    
                    //Get light number from jquery object's id
                    var light_id = controller.attr("id").split("_");
                    light_id = light_id[1];

                    switch ($.trim($(controller).text().toLowerCase())) {

                    case 'on':
                        socket.emit('publish', {
                            topic: 'home/light/'+ light_id +'/off',
                            message: '1'
                        });
                        break;

                    case 'off':
                        socket.emit('publish', {
                            topic: 'home/light/'+ light_id +'/on',
                            message: '1'
                        });
                        break;
                    }
                }

                //Send MPC control message, based on element ID
                function MPCControl(controller) {
                    //Second part of MPC_xxx, lowercased is the MQTT message
                    var action = controller.attr("id").split("_");
                    action = action[1].toLowerCase();

                    socket.emit('publish', {
                        topic: 'home/player/mpc/' + action,
                        message: '1'
                    });
                }

                // $(window).resize(function () {
                //     var new_size = ($(document).width() * 400) / 1680
                //     console.log(new_size);
                //     document.getElementById('sl1').style.width = 20;
                //     console.log("Grabbed", $("#sl1").width());
                // });

            </script>
</body>
</html>