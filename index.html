<!-- Copyright (c) 2014, Guilherme Ramos <longinus@gmail.com> -->
<!-- https://github.com/guibom/WebMQonttrol -->
<!-- Released under the MIT license. See LICENSE file for details. -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
    <title>Home Control</title>

    <!-- Bootstrap and Bootstrap-Slider CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/weather-icons.min.css" rel="stylesheet">
    <link href="css/jquery.nouislider.min.css" rel="stylesheet">
    <style>
        .label {
          padding: .2em .2em .3em;
        }
        .row {margin:  -7.5px}
        [class*="col-"] {padding: 2px 5px;}
    </style>

    <!-- jQuery -->
    <script type="text/javascript" src="js/jquery.min.js"></script>
    <!-- socket.io for communication -->
    <script type="text/javascript" src="js/socket.io.min.js"></script>
    <script type="text/javascript">

        //Connect to socket and MQTT broker
        var socket = io.connect('http://192.168.0.175:3000');

        //Global variables
        var debug_show = true;  //If it's on, no panels will be hidden          
        var msg; //global msg variable

        //Object for Light messages
        var panelLight = {
            //Properties
            type: "Light",

            "home/light/1/status": function() {
                if (msg.payload == 'on') {
                    $('#Light_1').html('<span class="glyphicon glyphicon-ok"></span> ON');                        
                    $('#Light_1').removeClass('btn-danger').addClass('btn-success');
                } else {
                    $('#Light_1').html('<span class="glyphicon glyphicon-remove"></span> OFF');   
                    $('#Light_1').removeClass('btn-success').addClass('btn-danger');
                }
            },

            "home/light/1/status/brightness": function() {
                $('#Light_1_Brightness').text(msg.payload);
                $('#slider1').val(parseInt(msg.payload));
            },

            Control: function(controller) {
                //Get light number from jquery object's id
                var light_id = controller.attr("id").split("_");
                light_id = light_id[1];
                var current_status = $.trim($(controller).text().toLowerCase());
                var send_msg;

                //Toggle light status message
                if (current_status == "on") {
                    send_msg = "off";                            
                } else if (current_status == "off") {
                    send_msg = "on";                             
                }                            

                //Publish MQTT message
                socket.emit('publish', {
                    topic: 'home/light/' + light_id + '/' + send_msg,
                    message: '1'
                });
            }
        }

        //Object for iTunes messages
        var paneliTunes = {
            //Default values
            type: "iTunes",
            actionMessage: "home/player/itunes/",
            
            "home/player/itunes/status/playing": function() {
                if (msg.payload == '1') {                            
                    $("#iTunes_PlayPause").html('<span class="glyphicon glyphicon-pause"></span> Pause'); 
                    $("#iTunes_PlayPause").addClass('btn-warning').removeClass('btn-primary')
                } else {
                    $("#iTunes_PlayPause").html('<span class="glyphicon glyphicon-play"></span> Play');
                    $("#iTunes_PlayPause").addClass('btn-primary').removeClass('btn-warning')
                }
            },

            "home/player/itunes": function() {
                if (msg.payload == 'on') {                            
                    $("#iTunes_OpenClose").html('<span class="glyphicon glyphicon-off"></span> Close'); 
                    $("#iTunes_OpenClose").addClass('btn-warning').removeClass('btn-primary')
                    //Show title text element
                    $('#iTunes_Title').removeClass('hide');

                    //Enable all the buttons
                    $('#iTunes_Grid').find("button").each(function(index, element){
                        $(this).removeClass('disabled');
                    });

                } else {
                    $("#iTunes_OpenClose").html('<span class="glyphicon glyphicon-off"></span> Open');
                    $("#iTunes_OpenClose").addClass('btn-primary').removeClass('btn-warning')
                    //Hide title text element
                    $('#iTunes_Title').addClass('hide');

                    //Disable all the buttons. 
                    $('#iTunes_Grid').find("button").each(function(index, element){
                        $(this).addClass('disabled');
                    });
                    //Re-enable OpenClose button, since it works without iTunes open.
                    $('#iTunes_OpenClose').removeClass('disabled')
                }
            },

            "home/player/itunes/status/title": function() {
                if (msg.payload != "" && msg.payload != "0") {
                    $('#iTunes_Title').html(msg.payload); 
                } else {
                    $('#iTunes_Title').html('Title not found'); 
                }
            },

            Control: function(controller) {
                //Second part of MPC_xxx, lowercased is the MQTT message
                var action = controller.attr("id").split("_");
                action = action[1].toLowerCase();

                socket.emit('publish', {
                    topic: this.actionMessage + action,
                    message: '1'
                });
            }
        }

        //Object for MPC messages
        var panelMPC = {
            //Default values
            type: "MPC",
            actionMessage: "home/player/mpc/",
            MPCBarTotal: 0,

            "home/player/mpc": function() {                    
                if (msg.payload == 'on' || debug_show) {
                    $('#Player_MPC').removeClass('hide');
                } else {
                    $('#Player_MPC').addClass('hide');
                }
            },

            "home/player/mpc/status/total_time": function() {
                MPCBarTotal = msg.payload;                        
            },

            "home/player/mpc/status/current_time": function() {                        
                var current_time = parseInt(msg.payload);                        
                document.getElementById('MPCBar').style.width = ((current_time * 100) / MPCBarTotal) + '%';
            },

            "home/player/mpc/status/playing": function() {
                //Playing
                if (msg.payload == '1') {
                    $('#MPCBar').removeClass('hide')
                    $('#MPCBar_Base').addClass('active');

                    $("#MPC_PlayPause").html('<span class="glyphicon glyphicon-pause"></span> Pause'); 
                    $("#MPC_PlayPause").addClass('btn-warning').removeClass('btn-primary')
                //Paused
                } else if (msg.payload == "2") {
                    $('#MPCBar').removeClass('hide');
                    $('#MPCBar_Base').removeClass('active');

                    $("#MPC_PlayPause").html('<span class="glyphicon glyphicon-play"></span> Play');
                    $("#MPC_PlayPause").addClass('btn-primary').removeClass('btn-warning')
                //Stopped
                } else {
                    $('#MPCBar').addClass('hide');

                    $("#MPC_PlayPause").html('<span class="glyphicon glyphicon-play"></span> Play');
                    $("#MPC_PlayPause").addClass('btn-primary').removeClass('btn-warning')
                }
            },
            
            "home/player/mpc/status/filename": function() {
                if (msg.payload != "" && msg.payload != "0") {
                    $('#mpc_filename').html(msg.payload); 
                } else {
                    $('#mpc_filename').html('Filename not found'); 
                }
            },

            Control: function(controller) {
                //Second part of MPC_xxx, lowercased is the MQTT message
                var action = controller.attr("id").split("_");
                action = action[1].toLowerCase();

                socket.emit('publish', {
                    topic: this.actionMessage + action,
                    message: '1'
                });
            }
        }

        //File selection to start a video in MPC
        var panelMPCSelection = {
            //Default values
            requestMessage: "home/htpc/listfiles",
            playFileMessage: "home/player/mpc/open",
            extFilter: ["mkv", "mp4", "avi", "wmv"],
            currentPath: "",

            "home/htpc/listfiles/result": function() {
                if (msg.payload) {
                    var obj = jQuery.parseJSON(msg.payload);
                    var extFilter = this.extFilter;    
                    var myItems = [];
                    var $myList = $("#MPC_File_List");
                    
                    //Iterate over each file object
                    $.each( obj.files, function( key, value ) {
                        //Check if the file matches the filtered extensions        
                        $.each(extFilter, function(keyF, valueFilter) {
                            if (valueFilter == value.split('.').pop()) {
                                myItems.push( '<a href="#" class="list-group-item">' + value + '</a>' );
                                return false;                                
                            }
                        });                        
                    });

                    //Iterate over the folders to add.
                    $.each( obj.folders, function( key, value ) {  
                        myItems.push( '<a href="#" class="list-group-item"><span class="glyphicon glyphicon-folder-open"></span>  ' + value + '</a>' );
                    });

                    //Path that was used on json query
                    this.currentPath = obj.root;
                     
                    //Append all the HTML at once
                    $myList.append( myItems.join( "" ) );                    
                }                       
            },

            "Open": function(file) {

                if(file){
                    //Publish MQTT message
                    socket.emit('publish', {
                        topic: this.playFileMessage,
                        message: this.currentPath + "/" + file
                    });
                    console.log("Published ", this.currentPath + "/" + file);
                }                
            }
        }

        //Objects that hold the topic subscriptions and other values for that panel
        var masterPanel = [panelMPC, panelLight, paneliTunes, panelMPCSelection];

        //Create web socket and start listening for MQTT messages       
        socket.on('connect', function () {
            socket.on('mqtt', function (lastmsg) {

                //Save lastmsg
                msg = lastmsg;

                //Forward topic to the right object
                $.each(masterPanel, function(key, obj) {
                    if (obj[msg.topic])        
                        obj[msg.topic]();                   
                });
               
                //Preview of MQTT message
                $('#message').html(msg.topic + ', ' + msg.payload.substring(0, 100));
              
            });

            //Topic subscriptions
            socket.emit('subscribe', 
                {topic: 'home/light/1/status/#'}, 
                {topic: 'home/player/mpc'}, 
                {topic: 'home/player/mpc/status/#'},
                {topic: 'home/player/itunes'}, 
                {topic: 'home/player/itunes/status/#'},
                {topic: 'home/web/config/#'},
                {topic: 'home/htpc/#'}

                );
        });
    </script>
</head>

<body>
    <div id="wrap">
        <div class="container">

            <div id="alertWindow"></div>

            <div class="panel panel-default" style="border-radius: 0px; border: 0px; box-shadow: 0px 0px 0px 0px; margin-bottom: 0px">
                <div class="panel-body" style="border-radius: 0px; ">
                    <ul class="nav nav-tabs nav-justified" id="topTab">
                      <li class="active"><a href="#TabShowAll" data-toggle="tab"><span class="glyphicon glyphicon-home"></span> Main</a></li>
                      <li><a href="#Controller_Light" data-toggle="tab"><span class="glyphicon glyphicon-flash"></span> Light</a></li>
                      <li><a href="#Player_MPC" data-toggle="tab"><span class="glyphicon glyphicon-film"></span> MPC</a></li>
                      <li><a href="#Player_iTunes" data-toggle="tab"><span class="glyphicon glyphicon-music"></span> iTunes</a></li>
                      <li><a href="#Controller_PC" data-toggle="tab"><span class="glyphicon glyphicon-hdd"></span> PC</a></li>
                      <li><a href="#Status_Weather" data-toggle="tab"><i class="wi-horizon-alt"></i> Weather</a></li>
                    </ul>              
                </div>  
            </div>

            <!-- TAB PANE START -->
            <div class="tab-content">       

                <div class="tab-pane panel panel-default active" id="Controller_Light">
                    <div class="panel-heading">
                        <h3 class="panel-title"><span class="label label-default"><span class="glyphicon glyphicon-flash"></span> Light Control</span></h3>                        
                    </div>
                    <div class="panel-body" style="padding-top: 0px; padding-bottom: 0px">
                        <div class="row">
                            <div class="col-sm-4">
                                <h2><span class="label label-info" style="vertical-align:top; display: block; text-align:left; padding: .2em .4em .3em;">Sofa light</span></h2>
                            </div>
                            <div class="col-sm-1 col-xs-2">
                                <h2><span id="Light_1_Brightness" class="label label-default" style="vertical-align:top; display: block;">N/A</span></h2>
                            </div>
                            <div class="col-sm-5 col-xs-6" style="text-align:center; padding-top: 28px; padding-left: 20px; padding-right: 20px">                            
                                <div class="noUiSlider" id="slider1"></div>                            
                            </div>
                            <div class="col-sm-2 col-xs-4" style="text-align:right; vertical-align:center; padding-top: 14px; "><a href="#" id="Light_1" class="btn btn-block btn-lg btn-success" role="button" style="vertical-align:bottom; "><span class="glyphicon glyphicon-ok"></span> N/A</a>
                            </div>
                        </div>                    
                    </div>

                    <div class="panel-body" style="padding-top: 0px; padding-bottom: 0px">
                        <div class="row">
                            <div class="col-sm-10" >
                                <h2><span class="label label-info" style="vertical-align:top; display: block; text-align:left; padding: .2em .4em .3em;">TV light</span></h2>
                            </div>
                            <div class="col-sm-2" style="text-align:right; vertical-align:center; padding-top: 14px; "><a href="#" id="Light_2" class="btn btn-block btn-lg btn-success" role="button" style="vertical-align:bottom; "><span class="glyphicon glyphicon-ok"></span> N/A</a>
                            </div>
                        </div>                    
                    </div>
                </div>

                <div class="panel panel-default tab-pane active" id="Player_MPC">
                    <div class="panel-heading">
                        <h3 class="panel-title"><span class="label label-default"><span class="glyphicon glyphicon-film"></span> Media Player Control</span></h3>
                    </div>
                    <div class="panel-body">

                        <small id="mpc_filename">No video playing</small>

                        <div class="progress progress-striped" id="MPCBar_Base">
                            <div class="progress-bar" id="MPCBar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
                        </div>

                        <div class="row">
                            <div class="col-sm-3">
                                <button type="button" id="MPC_PlayPause" class="btn btn-primary btn-lg btn-block">
                                <span class="glyphicon glyphicon-play"></span> Play
                                </button>
                            </div>
                            <div class="col-sm-2">
                                <button type="button" id="MPC_Stop" class="btn btn-primary btn-lg btn-block">
                                <span class="glyphicon glyphicon-stop"></span> Stop
                                </button>
                            </div>
                            <div class="col-sm-2">
                                <button type="button" id="MPC_VolumeUp" class="btn btn-primary btn-lg btn-block">
                                <span class="glyphicon glyphicon-volume-up"></span> Vol.Up
                                </button>
                            </div>
                            <div class="col-sm-2">
                                <button type="button" id="MPC_VolumeDown" class="btn btn-primary btn-lg btn-block">
                                <span class="glyphicon glyphicon-volume-down"></span> Vol.Down
                                </button>
                            </div>
                            <div class="col-sm-3">
                                <button type="button" id="MPC_Fullscreen" class="btn btn-primary btn-lg btn-block">
                                <span class="glyphicon glyphicon-fullscreen"></span> Fullscreen
                                </button>
                            </div>
                        </div>

                    </div>
                </div>

                <div class="panel panel-default tab-pane active" id="Player_iTunes">
                    <div class="panel-heading">
                        <h3 class="panel-title"><span class="label label-default"><span class="glyphicon glyphicon-music"></span> iTunes Control</span></h3>
                    </div>
                    <div class="panel-body">
                        <p><small id="iTunes_Title">No music playing</small></p>
                        <div class="row" id="iTunes_Grid">
                            <div class="col-sm-3">
                                <button type="button" id="iTunes_PlayPause" class="btn btn-primary btn-lg btn-block">
                                <span class="glyphicon glyphicon-play"></span> Play
                                </button>
                            </div>
                            <div class="col-sm-2">
                                <button type="button" id="iTunes_Stop" class="btn btn-primary btn-lg btn-block">
                                <span class="glyphicon glyphicon-stop"></span> Stop
                                </button>
                            </div>
                            <div class="col-sm-2">
                                <button type="button" id="iTunes_VolumeUp" class="btn btn-primary btn-lg btn-block">
                                <span class="glyphicon glyphicon-volume-up"></span> Vol.Up
                                </button>
                            </div>
                            <div class="col-sm-2">
                                <button type="button" id="iTunes_VolumeDown" class="btn btn-primary btn-lg btn-block">
                                <span class="glyphicon glyphicon-volume-down"></span> Vol.Down
                                </button>
                            </div>
                            <div class="col-sm-3">
                                <button type="button" id="iTunes_OpenClose" class="btn btn-primary btn-lg btn-block">
                                <span class="glyphicon glyphicon-off"></span> Open
                                </button>
                            </div>
                        </div>

                    </div>
                </div>            
            </div>
            <!-- TAB PANE END -->
            
            <div class="list-group" id="MPC_File_List">
            </div>

            <div class="panel panel-default">
                <div class="panel-body">
                    <b>Last MQTT message:  </b>  <small id="message">no message recieved</small>
                </div>
            </div>

            <!-- .noUIslider Slider -->
            <script src="js/jquery.nouislider.min.js"></script>
            <script src="js/modernizr.js"></script>                
            <script src="js/tab.js"></script>
            
            <!-- Event handler scripts -->
            <script>
            $(function() {

                //Check if we have a valid websocket connection
                socket.on('error', function () {
                    console.log("Couldn't connect to the web socket!");
                    $("#alertWindow").html('<div class="alert alert-danger">Could not connect to the web socket server!</div>');
                })


                //Show all panels if Main tab clicked
                $('#topTab a').click(function (e) {
                    if ($.trim($(this).text()) == "Main") {
                        $('#Controller_Light').addClass('active');
                        $('#Player_MPC').addClass('active');
                        $('#Player_iTunes').addClass('active');
                    }
                });


                //Movie file selected
                $(document).on('click', '.list-group-item', function(){
                    panelMPCSelection.Open($.trim($(this).text()));
                });

          
                //noUiSlider Events
                $('.noUiSlider').noUiSlider({
                    range: [0, 100]
                    ,start: 0
                    ,step: 1
                    ,handles: 1     
                    ,serialization: {
                        resolution: 1
                    }
                    ,set: function(){                        
                        socket.emit('publish', {
                            topic: 'home/light/1/set',
                            message: new String($("#slider1").val())
                        });
                    }
                    ,slide: function(){
                        $('#Light_1_Brightness').text($("#slider1").val());
                    }
                });


                //Button event handler. Redirects to the appropriate function 
                $(".btn").click(function () {
                    //Get type of button from the start of the ID
                    var id_type = this.id.split("_");
                    var clicked_obj = $(this);

                    $.each(masterPanel, function(key, obj) {
                        if (obj.type == id_type[0]) {
                            obj.Control(clicked_obj);
                        }                        
                    });
                });

                //Find the current page size, and tweak accordingly
                tweakPageForEnvironment(findBootstrapEnvironment());

                //Special tweaks for different page sizes
                function tweakPageForEnvironment(env) {
                    switch (env) {

                        case "ExtraSmall":
                            //Remove icons from tab menu
                            $.each($("#topTab").find("a").contents(), function(key, obj) {                                        
                                if ($(obj)[0].nodeName == "#text")
                                    obj.data = "";
                            });
                            //Remove justified from tab menu
                            $("#topTab").removeClass("nav-justified");
                            //Remove every button
                            // $(".btn").contents().filter(function(){
                            //     return this.nodeType === 3;                    
                            // }).remove();
                    }
                }


                //Tweak page based on the screen resolution
                function findBootstrapEnvironment() {
                    var envs = ["ExtraSmall", "Small", "Medium", "Large"];
                    var envValues = ["xs", "sm", "md", "lg"];

                    $el = $('<div>');
                    $el.appendTo($('body'));

                    for (var i = envValues.length - 1; i >= 0; i--) {
                        var envVal = envValues[i];

                        $el.addClass('hidden-'+envVal);
                        if ($el.is(':hidden')) {
                            $el.remove();
                            return envs[i]
                        }
                    };
                }

                // $(window).resize(function () {
                //     //console.log($(document).width());
                //     console.log(findBootstrapEnvironment());
                // });
              
            });
            </script>
</body>
</html>